name: KCOV Bats Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Build your KCOV image using Dockerfile.kcovbase
      - name: Build KCOV Docker image
        run: |
          docker build -f Dockerfile.kcovbase -t kcov-test-image .

      # 3️⃣ Run .bats tests with KCOV inside the container
      - name: Run Bats tests with KCOV
        run: |
          mkdir -p coverage
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            kcov-test-image \
            /bin/sh -c "
              mkdir -p /workspace/coverage &&
              for f in tests/*.bats; do
                # Run each bats test with kcov coverage
                kcov --include-path=/workspace /workspace/coverage \$f
              done
            "

      # 4️⃣ Upload coverage directory as artifact
      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/
