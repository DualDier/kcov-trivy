name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test with Coverage
    runs-on: ubuntu-latest
    container:
      image: kcov/kcov:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats
        run: |
          apt-get update
          apt-get install -y bats

      - name: Run tests with coverage
        run: |
          mkdir -p coverage
          kcov --exclude-pattern=/usr coverage/ bats tests/

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/

      - name: Display coverage summary
        if: always()
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/index.json ]; then
            echo "âœ… Coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š View detailed report in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t myapp:latest .

      - name: Save Docker image
        run: docker save myapp:latest -o myapp.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: myapp.tar
          retention-days: 1

  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i myapp.tar

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:latest'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Trivy scan summary
        if: always()
        run: |
          echo "## Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Trivy scan completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Check Security tab for detailed results" >> $GITHUB_STEP_SUMMARY